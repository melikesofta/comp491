<html>
<head>
    <meta charset="utf-8">
    <style>
        .table {
            height: 100%;
            width: 100%;
            text-align: center;
            vertical-align: center;
            color: white;

        }
    </style>
</head>
<body style="padding-left: 328px" bgcolor="#353535">

<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="04-eksi-data.js" charset="utf-8"></script>
<script
        src="https://code.jquery.com/jquery-1.12.4.min.js"
        integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ="
        crossorigin="anonymous"></script>
<script type="text/javascript">


    function xyz(){
        val = Math.random() * 1000 + 1000
        sign = Math.sign( 0.5 - Math.random())

        return sign * val
    }

    //Width and height
    var w = 900;
    var h = 900;
    var diameter = 900;
    var COUNTER = 30;



    var svg = d3.select("body")
            .append("svg")
            .attr("width", diameter)
            .attr("height", diameter)
            .attr("class", "bubble");


    dataByYear = function (yil) {
        return data_by_year[yil + ""]
    }


    var bubble = d3.layout.pack()

            .sort(function (a, b) {
                return -(a.value - b.value)
            })

            .size([diameter, diameter])


    function handleTransition(bubles_transition) {
        var color = d3.scale.category10();


        bubles_transition.select("circle").attr("r", function (d) {
                    return d.r;
                })
                .attr("cx", function (d) {
                    return d.x;
                })
                .attr("cy", function (d) {
                    return d.y;
                })
                .style("fill", function (d) {
                    return color(d.value);
                });

        bubles_transition.select("foreignObject")
                .attr("x", function (d) {
                    return d.x - d.r;
                })
                .attr("y", function (d) {
                    return d.y - d.r;
                })
                .attr("width", function (d) {
                    return 2 * d.r
                })
                .attr("height", function (d) {
                    return 2 * d.r
                })
//        bubles_transition.select("foreignObject").append("xhtml:table").attr("class", "table")
//                .append("tr")
//                .append("td")
//                .html(function (d) {
//                    return d.name.split(' ').map(function (w) {
//                        return w[0].toUpperCase() + w.substr(1).toLowerCase()
//                    }).join(' ')
//                });

    }

    function handleExit(bubles_transition) {


        bubles_transition.select("circle")
                .attr("cx", function(d){return d.g_x})
                .attr("cy", function(d){return d.g_y})

        bubles_transition.select("foreignObject")
                .attr("x", function(d){return d.g_x})
                .attr("y", function(d){return d.g_y})

        console.log(bubles_transition);

    }
    function handleEnter(bubbles_enter) {
        var color = d3.scale.category10();
        group = bubbles_enter.append("g").attr("class", "bubble");


        group.append("circle")
            .attr("r", function (d) {return d.r;})
            .attr("cx", function(d){return d.g_x})
            .attr("cy", function(d){return d.g_y})
            .style("fill", function (d) { return color(d.value); })
            .transition().duration(2000)
            .attr("cx", function (d) { return d.x; })
            .attr("cy", function (d) { return d.y; })
            .style("fill", function (d) { return color(d.value); });

        foreign = group.append("foreignObject")
                .attr("x", function(d){return d.g_x})
                .attr("y", function(d){return d.g_y})
                .attr("width", function (d) {
                    return 2 * d.r
                })
                .attr("height", function (d) {
                    return 2 * d.r
                })

        foreign.transition().duration(2000)
                .attr("cx", function (d) { return d.x; })
                .attr("cy", function (d) { return d.y; })
        foreign.append("xhtml:table").attr("class", "table")
                .append("tr")
                .append("td")
                .html(function (d) {
                    return d.name.split(' ').map(function (w) {
                        return w[0].toUpperCase() + w.substr(1).toLowerCase()
                    }).join(' ')
                });

    }

    function go(yil) {

        var data = dataByYear(yil);

        var nodes = bubble.nodes({children: data}).filter(function (d) {
            return !d.children;
        });

        var bubbles = svg.append("g")
                .attr("transform", "translate(0,0)")
                .selectAll("circle")
                .data(nodes, function (x) {
                    return x.name
                })

        handleEnter(bubbles.enter());
    }


    function go2(yil) {

        var color = d3.scale.category10();

        var data = dataByYear(yil).map(function(x){
            x.g_x = xyz();
            x.g_y = xyz();
            return x
        });

        var nodes = bubble.nodes({children: data}).filter(function (d) {
            return !d.children;
        });

        var bubbles = svg.selectAll("g.bubble")
                .data(nodes, function (x) {
                    return x.name
                })

        handleEnter(bubbles.enter());
        handleTransition(bubbles.transition().duration(3000));
        handleExit(bubbles.exit().transition().duration(3000));
        bubbles.exit().transition().delay(3100).remove()
    }


    document.onkeydown = function (e) {
        switch (e.keyCode) {
            case 37:
                break;
            case 38:

                go2(++COUNTER);
                break;
            case 39:
                break;
            case 40:
                go2(--COUNTER);

                break;
        }
    };

    $(function(){
        go2(2000);
        $("body").append("<hr>")
        $p = $("body").append("<p>").css("color", "white")
        for(i = 1999; i< 2017; i++){
            $p.append('<a style="color: white"  onclick="go2(' + i + ')" href=#>' + i + '</a> - ').css("color", "white")
        }
    })


</script>
</body>
</html>